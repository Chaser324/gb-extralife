
#################
### CONSTANTS ###
#################

PLAYER_URL = 'http://www.twitch.tv/widgets/raw/live_embed_player.swf'
STREAM_API_URL = 'https://api.twitch.tv/kraken/streams/'
IRC_URL = 'http://webchat.quakenet.org/?channels=gbendurancerun&uio=MT1mYWxzZSY4PWZhbHNlJjExPTM2OSYxMz1mYWxzZSYxND1mYWxzZQfc'

CHAT_WIDTH = 300
CHAT_TAB_HEIGHT = 42

WIDTH_LARGE = 0
HEIGHT_LARGE = 0

WIDTH_MED = 0
HEIGHT_MED = 0

WIDTH_SMALL = 0
HEIGHT_SMALL = 0

BANNER_HEIGHT = 252

TOTAL_UPDATE_RATE = 300000
STREAM_UPDATE_RATE = 90000

flashvars = 
    enable_javascript: "true"
    fullscreen_click: "true"
    video_width: "427"
    video_height: "240"
    auto_play: "true"

params =
    allowFullScreen: "true"
    allowscriptaccess: "always"
    wmode: "opaque"

attributes = 
    "class": "layoutElement"

users = 
    1:
        username: 'Matt'
        fund: 'http://www.extra-life.org/participant/pascual'
        stream: 'mattpascual'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/50/1713152-avatar.png'
    2:
        username: 'Happenstance'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=45198'
        stream: 'happenstanceuk'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/13/132030/2445765-6184784399-norma.jpg'
    3:
        username: 'Chaser324'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=45793'
        stream: 'chasepettit'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/2840/961540-profile.png'
    4:
        username: 'Crispy'
        fund: 'http://www.extra-life.org/participant/Crispy'
        stream: 'CrispyLovesYou'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/1587/1095730-nekkiddave.jpg'
    5:
        username: 'TheFakePsychic'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=51960'
        stream: 'thefakepsychic'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/12/121659/2550653-naoto+winter+icon.png'
    6:
        username: 'thdemn'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=51931'
        stream: 'grtnpwrflgary'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/14/148764/2345749-8_bit_cody.gif'
    7:
        username: 'IrrelevantJohn'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=51999'
        stream: 'lleg3nd'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/209/2351454-icon1.png'
    8:
        username: 'ArclightBorealis'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=47921'
        stream: 'arclightborealis'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/7785/2531220-avatar.png'
    9:
        username: 'Fattony12000'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=45819'
        stream: 'fattony12000'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/8/88760/2190087-max_opp_crop.jpg'
    10:
        username: 'Rincewind'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=52246'
        stream: 'rincewind_uk'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/8/87446/2511144-2510225-taswell.jpg'
    11:
        username: 'RandyF'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=50573'
        stream: 'rabdt'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/7/79739/1293428-120px_smw_mario_holding_a_shell.jpg'
    12:
        username: 'Skytylz'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=52622'
        stream: 'skytylz'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/2/29721/2509953-2459536-2135100-2135095-newavatar.jpg'
    13:
        username: 'GullumF'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=52603'
        stream: 'GullumF'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/5/59857/1147869-avatar_body.png'
    14:
        username: 'mwjeffcott'
        fund: 'http://www.extra-life.org/participant/mwjeffcott'
        stream: 'mwjeffcott'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/3/37622/1059624-playstation_1_one_sony_audiophile_cd_player_transport_rca_1.jpg'
    15:
        username: 'Danteveli'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=52909'
        stream: 'danteveli24'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/9/95390/2463117-develi.jpg'
    16:
        username: 'coribald'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donordrive.participant&participantID=52939'
        stream: 'coribald'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/14/140836/2205878-2205876-c4zcg.jpg'
    17:
        username: 'shinboy630'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=52918'
        stream: 'shinboy630'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/14/142023/2455540-2455538-8722972267-cyberp.jpeg'
    18:
        username: 'busted1der'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donordrive.participant&participantID=48731'
        stream: 'JacobMcCourt'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/8525/2207947-2207946-img_20120319_00080.jpg'
    19:
        username: 'PXAbstraction'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=47415'
        stream: 'PXAbstraction'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/1/17949/1917373-pxaavatar.jpg'
    20:
        username: 'Sparklykiss'
        fund: 'http://www.extra-life.org/participant/Sparklykiss'
        stream: 'sparklykiss'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/6/63338/2141065-sparklykisspony.png'
    22:
        username: 'Confirm4Crit'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=53737'
        stream: 'confirm4crit'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/15/151224/2510387-14ysjt.png'
    23:
        username: 'subrandom'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=46734'
        stream: 'subrandom'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/191/1322646-objection.png'
    24:
        username: 'TonyBlue87'
        fund: 'http://www.extra-life.org/team/happyhourimprov'
        stream: 'happyhourimprov'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/7/71314/1724240-sparkster_tron.png'
    25:
        username: 'Nickieroonie'
        fund: 'http://www.extra-life.org/participant/nickieroonie'
        stream: 'nickieroonie'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/11/116307/1645548-metadp.jpg'
    26:
        username: 'LaserJesus'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=54268'
        stream: 'lasermessiah'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/9/91592/1351458-ljriflesteam.jpg'
    27:
        username: 'datarez'
        fund: 'http://www.extra-life.org/participant/datarez'
        stream: 'datarez'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/1592/1542722-ned_stark_game_of_thrones.jpg'
    28:
        username: 'RioStarwind'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=54461'
        stream: 'riostarwind'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/5/56971/2380994-images.jpg'
    29:
        username: 'KingRingtail85'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=54458'
        stream: 'jeff_mcfly'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/6/66397/2533827-daft-punk-helmets-columbia-album-artwork.jpg'
    30:
        username: 'eccentrix'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=54707'
        stream: 'eccentrix'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/6/65153/1325815-77522907342156928d992e8he.gif'
    31:
        username: 'Capaneus'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donordrive.participant&participantID=53121'
        stream: 'capane_us'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/11/110891/2522906-metroid4_07.png'
    32:
        username: 'Squill2k4'
        fund: 'http://www.extra-life.org/index.cfm?fuseaction=donorDrive.participant&participantID=54767'
        stream: 'squill2k4'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/15/156838/2386706-rebel_alliance_logo.svg.png'
    33:
        username: 'B0nd07'
        fund: 'http://www.extra-life.org/participant/b0nd07'
        stream: 'b0nd07'
        profilePic: 'http://static.giantbomb.com/uploads/square_mini/0/8991/2274238-avatar3.png'



#################
### VARIABLES ###
#################

currentLayout = ''
currentChat = IRC_URL

layouts = null

#################
### FUNCTIONS ###
#################

initPage = ->
    param1 = getURLParameter '1'
    param2 = getURLParameter '2'
    param3 = getURLParameter '3'
    initLayout = getURLParameter 'layout'

    if param1 isnt null
        playerChannels['stream1'] = param1
    if param2 isnt null
        playerChannels['stream2'] = param2
    if param3 isnt null
        playerChannels['stream3'] = param3
    if initLayout is null
        initLayout = 'threeUp'

    $('#chat1').show()

    for key, value of playerChannels
        addPlayer value, key
    setupLayout initLayout

initEvents = ->
    $('.alert').bind 'closed.bs.alert', ->
        setTimeout doResize, 100
    setTimeout updateTotal, 5000

    $("a[href='#info-content']").click ->
        $('#content-nav li a.active').removeClass 'active'
        $("#content-nav li a[href='#info-content']").addClass 'active'
        $('#stream-index').hide 0
        $('#info-content').show 0, ->
            $('html, body').animate
                scrollTop: $("#content-nav").offset().top
                , 600
    $("a[href='#stream-index']").click ->
        $('#content-nav li a.active').removeClass 'active'
        $("#content-nav li a[href='#stream-index']").addClass 'active'
        $('#info-content').hide 0
        $('#stream-index').show 0, ->
            $('html, body').animate
                scrollTop: $("#content-nav").offset().top
                , 600

    $('a.tweet-link').click (e) ->
        e.preventDefault()
        loc = $(this).attr 'href'
        window.open loc, 'twitterwindow', 'height=450, width=550, top=' + ($(window).height()/2 - 225) + ', left=' + $(window).width()/2 + ', toolbar=0, location=0, menubar=0, directories=0, scrollbars=0'

initIndex = ->
    source = $('#index-template').html()
    template = Handlebars.compile source
    context = {users}
    html = template context
    
    $('#stream-container').append html

    $('.index-entry:nth-child(4n+5)').css "clear", "both"

    $('.index-entry').each ->
        refreshStream $(this).attr 'data-channel'

refreshStream = (channel) ->
    $.ajax
        type: 'GET'
        dataType: 'jsonp'
        crossDomain: true
        jsonp: 'callback'
        url: STREAM_API_URL + channel
        success: (data) ->
            stream = data["stream"]
            channelEntry = $("div[data-channel='" + channel + "']")
            if stream is null
                channelEntry.find('p.live').removeClass 'on-air'
                channelEntry.find('.stream-pic').removeClass 'on-air'
                channelEntry.find('h2').text 'Off-Air'
                channelEntry.find('.game-title').text 'nothing at the moment'
            else
                channelEntry.find('p.live').addClass 'on-air'
                channelEntry.find('.stream-pic').addClass 'on-air'
                channelEntry.find('h2').text stream["channel"]["status"]
                channelEntry.find('.stream-pic').attr 'src', stream["preview"]["medium"]
                channelEntry.find('.game-title').text stream["channel"]["game"]


        complete:
            setTimeout (-> refreshStream channel), STREAM_UPDATE_RATE



doResize = ->
    setupLayout currentLayout

setCoords = ->
    if $('#chat1').is(":visible")
        CHAT_WIDTH = 300
    else
        CHAT_WIDTH = 0

    WIDTH_LARGE = $('#streams-wrapper').width() - CHAT_WIDTH
    HEIGHT_LARGE = (WIDTH_LARGE * 9/16) + 28

    WIDTH_MED = $('#streams-wrapper').width() / 2
    HEIGHT_MED = (WIDTH_MED * 9/16) + 28

    WIDTH_SMALL = WIDTH_LARGE / 2
    HEIGHT_SMALL = (WIDTH_SMALL * 9/16) + 28

    if currentLayout == "threeUpHorizontal"
        WIDTH_SMALL = 300;
        HEIGHT_SMALL = 200;

        WIDTH_LARGE = $('#streams-wrapper').width() - WIDTH_SMALL;
        HEIGHT_LARGE = (WIDTH_LARGE * 9/16) + 28

    height = 0

    if currentLayout == "threeUp"
        height = HEIGHT_LARGE + HEIGHT_SMALL
    else if currentLayout == "threeUpHorizontal"
        height = HEIGHT_LARGE
    else if currentLayout == "oneUp"
        height = HEIGHT_LARGE
    else
        height = HEIGHT_MED * 2

    top = $('#streams-wrapper').position().top
    winHeight = $(window).height()

    if (top + height) > winHeight
        desiredHeight = winHeight - top
        scale = desiredHeight / height

        HEIGHT_LARGE *= scale;
        WIDTH_LARGE = (HEIGHT_LARGE - 28) * 16/9

        WIDTH_MED = (HEIGHT_MED - 28) * 16/9
        HEIGHT_MED *= scale

        WIDTH_SMALL = (WIDTH_LARGE / 2)
        HEIGHT_SMALL = (WIDTH_SMALL * 9/16) + 28

        CHAT_WIDTH = $('#streams-wrapper').width() - WIDTH_LARGE

    layouts =
        grid:
            stream1:
                x: 0
                y: 0
                width: WIDTH_MED
                height: HEIGHT_MED
            stream2:
                x: WIDTH_MED
                y: 0
                width: WIDTH_MED
                height: HEIGHT_MED
            stream3:
                x: 0
                y: HEIGHT_MED
                width: WIDTH_MED
                height: HEIGHT_MED
            chat1:
                x: WIDTH_MED
                y: HEIGHT_MED + CHAT_TAB_HEIGHT
                width: WIDTH_MED
                height: HEIGHT_MED - CHAT_TAB_HEIGHT - 8
            chat2:
                x: WIDTH_MED
                y: HEIGHT_MED + CHAT_TAB_HEIGHT
                width: WIDTH_MED
                height: HEIGHT_MED - CHAT_TAB_HEIGHT - 8
            chatnav:
                x: WIDTH_MED
                y: HEIGHT_MED
                width: WIDTH_MED
                height: CHAT_TAB_HEIGHT
            overallHeight: HEIGHT_MED * 2
        oneUp:
            stream1:
                x: 0
                y: 0
                width: WIDTH_LARGE
                height: HEIGHT_LARGE
            chat1:
                x: WIDTH_LARGE
                y: CHAT_TAB_HEIGHT
                width: CHAT_WIDTH
                height: HEIGHT_LARGE - CHAT_TAB_HEIGHT - 8
            chat2:
                x: WIDTH_LARGE
                y: CHAT_TAB_HEIGHT
                width: CHAT_WIDTH
                height: HEIGHT_LARGE - CHAT_TAB_HEIGHT - 8
            chatnav:
                x: WIDTH_LARGE
                y: 0
                width: CHAT_WIDTH
                height: CHAT_TAB_HEIGHT
            overallHeight: HEIGHT_LARGE
        threeUp:
            stream1:
                x: 0
                y: 0
                width: WIDTH_LARGE
                height: HEIGHT_LARGE
            stream2:
                x: 0
                y: HEIGHT_LARGE
                width: WIDTH_SMALL
                height: HEIGHT_SMALL
            stream3:
                x: WIDTH_SMALL
                y: HEIGHT_LARGE
                width: WIDTH_SMALL
                height: HEIGHT_SMALL
            chat1:
                x: WIDTH_LARGE
                y: CHAT_TAB_HEIGHT
                width: CHAT_WIDTH
                height: HEIGHT_LARGE + HEIGHT_SMALL - CHAT_TAB_HEIGHT - 8
            chat2:
                x: WIDTH_LARGE
                y: CHAT_TAB_HEIGHT
                width: CHAT_WIDTH
                height: HEIGHT_LARGE + HEIGHT_SMALL - CHAT_TAB_HEIGHT - 8
            chatnav:
                x: WIDTH_LARGE
                y: 0
                width: CHAT_WIDTH
                height: CHAT_TAB_HEIGHT
            overallHeight: HEIGHT_LARGE + HEIGHT_SMALL
        twoUp:
            stream1:
                x: 0
                y: 0
                width: WIDTH_MED
                height: HEIGHT_MED
            stream2:
                x: 0
                y: HEIGHT_MED
                width: WIDTH_MED
                height: HEIGHT_MED
            chat1:
                x: WIDTH_MED
                y: CHAT_TAB_HEIGHT
                width: WIDTH_MED
                height: HEIGHT_MED * 2 - CHAT_TAB_HEIGHT - 8
            chat2:
                x: WIDTH_MED
                y: CHAT_TAB_HEIGHT
                width: WIDTH_MED
                height: HEIGHT_MED * 2 - CHAT_TAB_HEIGHT - 8
            chatnav:
                x: WIDTH_MED
                y: 0
                width: WIDTH_MED
                height: CHAT_TAB_HEIGHT
            overallHeight: HEIGHT_MED * 2

setupLayout = (layoutType) ->
    currentLayout = layoutType
    setCoords()
    $('div.layoutElement').each (index) ->
        layoutElement $(this), layouts[layoutType][$(this).attr('id')]

    layoutPlayerSlot 'stream1'
    layoutPlayerSlot 'stream2'
    layoutPlayerSlot 'stream3'

    layoutChat 'chat1'
    layoutChat 'chat2'

    layoutChatNav 'chatnav'

    $('#streams-wrapper').height layouts[currentLayout].overallHeight


layoutChat = (chat) ->
    layout = layouts[currentLayout][chat]
    chat = $('#' + chat)

    if layout
        chat.css 'left', layout.x
        chat.css 'top', layout.y
        chat.width layout.width
        chat.height layout.height

layoutChatNav = (chatnav) ->
    layout = layouts[currentLayout][chatnav]
    chatnav = $('#' + chatnav)

    if layout
        chatnav.css 'left', layout.x
        chatnav.css 'top', layout.y
        chatnav.width layout.width
        chatnav.height layout.height

toggleChat = ->
    $('#chat1').toggle()
    layout(currentLayout)

layoutPlayerSlot = (slot) ->
    layout = layouts[currentLayout][slot]
    player = $('#' + slot)
    overlay = $('#' + slot + 'Overlay')
    number = slot.charAt (slot.length - 1)

    if layout
        if player.is('div')
            addPlayer(playerChannels[slot], slot)
            player = $('#' + slot)
        player.css 'left', layout.x
        player.css 'top', layout.y
        player.width layout.width
        player.height layout.height

        overlay.css 'left', layout.x
        overlay.css 'top', layout.y
        overlay.width layout.width
        overlay.height layout.height - 30
        overlay.tooltip
            title: number + ': ' + playerChannels[slot]
    else
        removePlayer player
        overlay.hide()

layoutElement = (element, layout) ->
    if layout
        element.css 'left', layout.x
        element.css 'top', layout.y
        element.width layout.width
        element.height layout.height

        element.show()
    else
        element.hide()

embedPlayer = (channel, replaceElem) ->
    swfobject.embedSWF(PLAYER_URL + "?channel=" + channel,replaceElem,"100","100","9.0.0",
        "expressInstall.swf",flashvars,params,attributes)

addPlayer = (channelName, slotName) ->
    embedPlayer channelName, slotName
    $('#' + slotName).attr('class','layoutElement')

removePlayer = (playerElement) ->
    name = playerElement.attr 'id'
    div = "<div id='" + name + "'></div>"
    playerElement.replaceWith(div)

updateTotal = ->    
    $.ajax
        type: 'GET'
        url: 'http://www.extra-life.org/index.cfm?fuseaction=widgets.300x250thermo&teamID=10592'
        success: (data) ->
            value = $(data.responseText).find('#mercury em').text()
            $('#total-value').text(value)
        complete: ->
            setTimeout updateTotal, TOTAL_UPDATE_RATE

swapStream = (slot, channel) ->
    playerChannels[slot] = channel
    removePlayer $('#'+slot)
    setupLayout currentLayout

loadChat = (channel) ->
    channelKey = channel
    if channel != 'irc'
        channel = playerChannels[channel]
        $('#chat1').hide()
        $('#chat2').show()
    else 
        $('#chat2').hide()
        $('#chat1').show()

    if (channel != currentChat) and (channel != 'irc')
        document.getElementById('chat2').src = getChatUrl(channel)
        currentChat = channel
        
    $('#chatnav ul li a.active').removeClass 'active'
    $("#chatnav ul li a[data-chat='" + channelKey + "']").addClass 'active'

getChatUrl = (channel) ->
    url = ''
    if channel == 'irc'
        url = IRC_URL;
    else
        url = 'http://www.twitch.tv/chat/embed?channel=' + channel + '&popout_chat=true'
    return url

getURLParameter = (name) -> 
    decodeURIComponent((new RegExp("[?|&]#{name}=([^&;]+?)(&|##|;|$)").exec(location.search) || [null,""] )[1].replace(/\+/g, '%20'))||null;

###################
### MAIN SCRIPT ###
###################



$(window).load ->
    initPage()
    initEvents()
    initIndex()
    
$(window).resize ->
    doResize()

